<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSR</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.4eabd1e9.css" as="style"><link rel="preload" href="/blog/assets/js/app.df63471f.js" as="script"><link rel="preload" href="/blog/assets/js/2.eb95d593.js" as="script"><link rel="preload" href="/blog/assets/js/96.33b1eaf3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ea032475.js"><link rel="prefetch" href="/blog/assets/js/100.246ac665.js"><link rel="prefetch" href="/blog/assets/js/101.4b15b483.js"><link rel="prefetch" href="/blog/assets/js/102.fa0ad7b1.js"><link rel="prefetch" href="/blog/assets/js/103.d6c7017e.js"><link rel="prefetch" href="/blog/assets/js/104.3874d3c3.js"><link rel="prefetch" href="/blog/assets/js/105.dcd8033f.js"><link rel="prefetch" href="/blog/assets/js/106.3d4885c0.js"><link rel="prefetch" href="/blog/assets/js/107.7beb8f02.js"><link rel="prefetch" href="/blog/assets/js/108.4f53070e.js"><link rel="prefetch" href="/blog/assets/js/109.d82ccf36.js"><link rel="prefetch" href="/blog/assets/js/11.8913cbbf.js"><link rel="prefetch" href="/blog/assets/js/110.56ce1547.js"><link rel="prefetch" href="/blog/assets/js/111.52fe6828.js"><link rel="prefetch" href="/blog/assets/js/112.12a3de47.js"><link rel="prefetch" href="/blog/assets/js/113.1be13771.js"><link rel="prefetch" href="/blog/assets/js/114.8fb091fc.js"><link rel="prefetch" href="/blog/assets/js/115.a0bd8cd0.js"><link rel="prefetch" href="/blog/assets/js/116.a871c595.js"><link rel="prefetch" href="/blog/assets/js/117.f3b0118a.js"><link rel="prefetch" href="/blog/assets/js/118.2724dd88.js"><link rel="prefetch" href="/blog/assets/js/119.6bb836bf.js"><link rel="prefetch" href="/blog/assets/js/12.09a00ceb.js"><link rel="prefetch" href="/blog/assets/js/120.e79efeaf.js"><link rel="prefetch" href="/blog/assets/js/121.458d3516.js"><link rel="prefetch" href="/blog/assets/js/122.2f2ceec2.js"><link rel="prefetch" href="/blog/assets/js/123.0d9d5a45.js"><link rel="prefetch" href="/blog/assets/js/124.01010414.js"><link rel="prefetch" href="/blog/assets/js/125.4cb1de70.js"><link rel="prefetch" href="/blog/assets/js/126.da65eda2.js"><link rel="prefetch" href="/blog/assets/js/127.b3f3175b.js"><link rel="prefetch" href="/blog/assets/js/128.7d9c6f4b.js"><link rel="prefetch" href="/blog/assets/js/129.cbccaa54.js"><link rel="prefetch" href="/blog/assets/js/13.f840d254.js"><link rel="prefetch" href="/blog/assets/js/130.7f3dcf65.js"><link rel="prefetch" href="/blog/assets/js/131.f56e75f8.js"><link rel="prefetch" href="/blog/assets/js/14.4830f544.js"><link rel="prefetch" href="/blog/assets/js/15.095c4a02.js"><link rel="prefetch" href="/blog/assets/js/16.e64dbc45.js"><link rel="prefetch" href="/blog/assets/js/17.e46092db.js"><link rel="prefetch" href="/blog/assets/js/18.06d22c95.js"><link rel="prefetch" href="/blog/assets/js/19.04aa56f6.js"><link rel="prefetch" href="/blog/assets/js/20.cf3f19c6.js"><link rel="prefetch" href="/blog/assets/js/21.73fa71fd.js"><link rel="prefetch" href="/blog/assets/js/22.529edf77.js"><link rel="prefetch" href="/blog/assets/js/23.b52c96a5.js"><link rel="prefetch" href="/blog/assets/js/24.c607eba1.js"><link rel="prefetch" href="/blog/assets/js/25.98e094a0.js"><link rel="prefetch" href="/blog/assets/js/26.645f5b42.js"><link rel="prefetch" href="/blog/assets/js/27.133e5374.js"><link rel="prefetch" href="/blog/assets/js/28.888f0e7f.js"><link rel="prefetch" href="/blog/assets/js/29.64438229.js"><link rel="prefetch" href="/blog/assets/js/3.2d2a2e3a.js"><link rel="prefetch" href="/blog/assets/js/30.f0c60d51.js"><link rel="prefetch" href="/blog/assets/js/31.0c081163.js"><link rel="prefetch" href="/blog/assets/js/32.f2d0e590.js"><link rel="prefetch" href="/blog/assets/js/33.e35002c1.js"><link rel="prefetch" href="/blog/assets/js/34.d4bfe97e.js"><link rel="prefetch" href="/blog/assets/js/35.c12a2280.js"><link rel="prefetch" href="/blog/assets/js/36.e09a446c.js"><link rel="prefetch" href="/blog/assets/js/37.9d0b1661.js"><link rel="prefetch" href="/blog/assets/js/38.d774b182.js"><link rel="prefetch" href="/blog/assets/js/39.b73923d1.js"><link rel="prefetch" href="/blog/assets/js/4.7c9b97b5.js"><link rel="prefetch" href="/blog/assets/js/40.976d0152.js"><link rel="prefetch" href="/blog/assets/js/41.686883f3.js"><link rel="prefetch" href="/blog/assets/js/42.a2d08393.js"><link rel="prefetch" href="/blog/assets/js/43.04199cb8.js"><link rel="prefetch" href="/blog/assets/js/44.35776351.js"><link rel="prefetch" href="/blog/assets/js/45.779835a6.js"><link rel="prefetch" href="/blog/assets/js/46.4c2de7d3.js"><link rel="prefetch" href="/blog/assets/js/47.d76beea3.js"><link rel="prefetch" href="/blog/assets/js/48.014f8f05.js"><link rel="prefetch" href="/blog/assets/js/49.6abb9e38.js"><link rel="prefetch" href="/blog/assets/js/5.738259de.js"><link rel="prefetch" href="/blog/assets/js/50.8127bf87.js"><link rel="prefetch" href="/blog/assets/js/51.06c619b3.js"><link rel="prefetch" href="/blog/assets/js/52.1684efcf.js"><link rel="prefetch" href="/blog/assets/js/53.f3af4702.js"><link rel="prefetch" href="/blog/assets/js/54.c7af5dfb.js"><link rel="prefetch" href="/blog/assets/js/55.c8a21bbd.js"><link rel="prefetch" href="/blog/assets/js/56.f4c1006f.js"><link rel="prefetch" href="/blog/assets/js/57.861d251c.js"><link rel="prefetch" href="/blog/assets/js/58.0df0c71e.js"><link rel="prefetch" href="/blog/assets/js/59.bbd9e052.js"><link rel="prefetch" href="/blog/assets/js/6.fe2a520b.js"><link rel="prefetch" href="/blog/assets/js/60.bae38579.js"><link rel="prefetch" href="/blog/assets/js/61.8beac3dd.js"><link rel="prefetch" href="/blog/assets/js/62.ccf0c054.js"><link rel="prefetch" href="/blog/assets/js/63.4cc155fe.js"><link rel="prefetch" href="/blog/assets/js/64.dc75466d.js"><link rel="prefetch" href="/blog/assets/js/65.8b8da0f0.js"><link rel="prefetch" href="/blog/assets/js/66.2470e913.js"><link rel="prefetch" href="/blog/assets/js/67.a05d7707.js"><link rel="prefetch" href="/blog/assets/js/68.6ef6c3e1.js"><link rel="prefetch" href="/blog/assets/js/69.10494f1f.js"><link rel="prefetch" href="/blog/assets/js/7.9571d162.js"><link rel="prefetch" href="/blog/assets/js/70.11e62079.js"><link rel="prefetch" href="/blog/assets/js/71.67a51e22.js"><link rel="prefetch" href="/blog/assets/js/72.660a1830.js"><link rel="prefetch" href="/blog/assets/js/73.da39ea58.js"><link rel="prefetch" href="/blog/assets/js/74.0cd18f8a.js"><link rel="prefetch" href="/blog/assets/js/75.afd118c6.js"><link rel="prefetch" href="/blog/assets/js/76.58dfb6b9.js"><link rel="prefetch" href="/blog/assets/js/77.f57ef647.js"><link rel="prefetch" href="/blog/assets/js/78.34317654.js"><link rel="prefetch" href="/blog/assets/js/79.f4e792e5.js"><link rel="prefetch" href="/blog/assets/js/8.ae3a44a4.js"><link rel="prefetch" href="/blog/assets/js/80.d8fc67a7.js"><link rel="prefetch" href="/blog/assets/js/81.13e4214a.js"><link rel="prefetch" href="/blog/assets/js/82.647fb8a2.js"><link rel="prefetch" href="/blog/assets/js/83.4104e2e5.js"><link rel="prefetch" href="/blog/assets/js/84.fa6e4a19.js"><link rel="prefetch" href="/blog/assets/js/85.7bd66a7c.js"><link rel="prefetch" href="/blog/assets/js/86.7f6ed3ff.js"><link rel="prefetch" href="/blog/assets/js/87.a943557e.js"><link rel="prefetch" href="/blog/assets/js/88.cb1333e3.js"><link rel="prefetch" href="/blog/assets/js/89.34a9590c.js"><link rel="prefetch" href="/blog/assets/js/9.30b72d1f.js"><link rel="prefetch" href="/blog/assets/js/90.eed9e769.js"><link rel="prefetch" href="/blog/assets/js/91.03a71ebd.js"><link rel="prefetch" href="/blog/assets/js/92.02cd8453.js"><link rel="prefetch" href="/blog/assets/js/93.c3a3ddb2.js"><link rel="prefetch" href="/blog/assets/js/94.e935edab.js"><link rel="prefetch" href="/blog/assets/js/95.48a48f8e.js"><link rel="prefetch" href="/blog/assets/js/97.a162e7d2.js"><link rel="prefetch" href="/blog/assets/js/98.44b96d7a.js"><link rel="prefetch" href="/blog/assets/js/99.60ba5cc9.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.4eabd1e9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/browser/" class="nav-link">browser</a></li><li class="dropdown-item"><!----> <a href="/blog/HTTP/" class="nav-link">HTTP</a></li><li class="dropdown-item"><!----> <a href="/blog/HTML/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/" class="nav-link router-link-active">Vue</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/browser/" class="nav-link">browser</a></li><li class="dropdown-item"><!----> <a href="/blog/HTTP/" class="nav-link">HTTP</a></li><li class="dropdown-item"><!----> <a href="/blog/HTML/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/blog/JS/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/" class="nav-link router-link-active">Vue</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>思想</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/Vue/思想/复用.html" class="sidebar-link">复用机制</a></li><li><a href="/blog/Vue/思想/DOM异步更新队列.html" class="sidebar-link">DOM异步更新队列</a></li><li><a href="/blog/Vue/思想/遐想.html" class="sidebar-link">Vue思想</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>组件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>生命周期</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>状态树</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>脚手架</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ssr"><a href="#ssr" aria-hidden="true" class="header-anchor">#</a> SSR</h1> <p>SSR全称server side render，服务端渲染，服务端渲染在很久以前我们就在做了，例如常见的php，和jsp，这么一说就很容易了解这个概念了，那么为什么在这个时间段，又说起了SSR呢了，在三个框架横行的今天，它有什么重大优势让三大框架都专门支持了呢？</p> <h2 id="ssr的权衡"><a href="#ssr的权衡" aria-hidden="true" class="header-anchor">#</a> SSR的权衡</h2> <h3 id="ssr的好处"><a href="#ssr的好处" aria-hidden="true" class="header-anchor">#</a> SSR的好处</h3> <p>CSR，客户端渲染，看一下CSR常见的问题</p> <p><strong>1.白屏现象</strong></p> <p>客户端渲染<strong>一般采用了AJAX来获取数据，然后利用框架渲染视图</strong>，<strong>由于获取数据和渲染视图的时间</strong>，特别是在<strong>网络情况不好或者设备性能不好的情况，白屏时间更加长，对这方面要求高的网站，尤其需要SSR</strong></p> <p><strong>2.SEO更好</strong></p> <p>由于传统<strong>SPA是走的AJAX获取数据，这方面只有谷歌会获取AJAX返回的内容，而其他引擎暂时不支持</strong>，这就意味着<strong>你的网站在搜索引擎面前，被人看到的机会会比正常网站机会要少</strong>，如果你希望你的网站排名尽可能高，SSR可以解决这个问题。</p> <h3 id="ssr的坏处"><a href="#ssr的坏处" aria-hidden="true" class="header-anchor">#</a> SSR的坏处</h3> <p>既然SSR能够彻底解决我们的痛点，那么为什么现在在外面公司听到SSR还是比较少呢，我们看看SSR的代价有哪些</p> <p><strong>1.开发条件严格</strong></p> <p><strong>浏览器和服务端的生命周期不一致</strong>，需要特殊处理</p> <p><strong>一些扩展库不能直接使用</strong>，需要特殊处理</p> <p><strong>2.构建和部署要求更多</strong></p> <p>比起SPA可以部署在任何服务器上，服务端渲染需要在Node环境下，当然，随着技术发展，现在已经可以部署在其他服务器上，只是需要花费多一点成本，官方已经提供了这方面的文档</p> <p><strong>3.更多的服务端压力</strong></p> <p>在服务端渲染，显示会增加服务器的压力，这属于CPU密集型，也称计算密集型，还记得吗，Node是在IO密集型上有重大优势，而计算密集型是单线程的弱势，这个话题到此为止，<strong>显然大量的服务端压力，需要更多的服务器支持，负载均衡等服务器策略，良好的缓存策略等支持</strong></p> <p>我们看到一开始SSR解决的痛点，不禁欣喜起来，马上就想使用，但是看一下我们SSR的代价，<strong>总体上，SSR增加了运维成本和开发成本，这是一笔不小的代价，以至于我们在考虑使用SSR时，一定要慎重考虑，是否真的有必要</strong></p> <h2 id="ssr核心流程"><a href="#ssr核心流程" aria-hidden="true" class="header-anchor">#</a> SSR核心流程</h2> <h3 id="组件渲染为字符串"><a href="#组件渲染为字符串" aria-hidden="true" class="header-anchor">#</a> 组件渲染为字符串</h3> <p><strong>SSR的本质是要得到渲染后的HTML字符串</strong>，关于这部分，这里我们可以采用官方的工具  <strong>vue-server-renderer</strong>,使用方法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;Hello World&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用的步骤很简单，运行此脚本，可以看到如下结果</p> <p><img src="https://s2.ax1x.com/2019/10/06/ucbCg1.png" alt="ucbCg1.png"></p> <p>我们已经成功得到了组件渲染后的字符串了</p> <p><strong>vue-server-renderer原理初探</strong></p> <p>带着好奇心，我想知道这个工具是怎么将组件生成了字符串，SPA的渲染流程是<strong>AST-&gt;render-&gt;Vnode-&gt;具体平台代码</strong>，我们看一下工具的源码是怎么处理的</p> <p>找到包的入口，发现开发环境下引入的文件</p> <p><img src="https://s2.ax1x.com/2019/10/06/ucL8hQ.png" alt="ucL8hQ.png"></p> <p>然后依次寻找</p> <div class="language-js extra-class"><pre class="language-js"><code>
createRenderer

createRenderer$<span class="token number">1</span>

createRenderer

render

createRenderFunction

renderNode


</code></pre></div><p><img src="https://s2.ax1x.com/2019/10/06/ucOu8J.png" alt="ucOu8J.png"></p> <p>这里我们看一下node,它是一个Vnode类型的数据，回头一下当初调用的参数</p> <p><img src="https://s2.ax1x.com/2019/10/06/ucONPe.png" alt="ucONPe.png"></p> <p>第一个参数就是Vnode，我们发现了</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>_render <span class="token comment">// 可以渲染为VNode</span>
</code></pre></div><p>验证一下</p> <p><img src="https://s2.ax1x.com/2019/10/06/ucObiF.png" alt="ucObiF.png"></p> <p>Vue实例调用_render之后，我们得到了组件的VNode，有了
VNode，就可以生成我们想要的东西了，比如字符串，这里就不再深入了</p> <h3 id="配合服务器"><a href="#配合服务器" aria-hidden="true" class="header-anchor">#</a> 配合服务器</h3> <p>业务中，我们会将服务端使用这个工具，下面是配合node的express搭建服务器输出现有的组件HTML</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建实例</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> req<span class="token punctuation">.</span>url
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;访问的 URL 是： {{ url }}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 输出为字符串</span>
  renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 不加这行会乱码</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;!DOCTYPE html&gt;
      &lt;html lang=&quot;en&quot;&gt;
        &lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
        &lt;body&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/body&gt;
      &lt;/html&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><p>上述例子在本机的8080端口搭建了一个服务器，访问效果如下</p> <p><img src="https://s2.ax1x.com/2019/10/06/ucyCeP.png" alt="ucyCeP.png"></p> <p>更重要的是，利用浏览器的开发者工具查看，我们的网页不再是空空的一个</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>而是</p> <p><img src="https://s2.ax1x.com/2019/10/06/ucyaex.png" alt="ucyaex.png"></p> <p>在我们访问时，就得到了完整的html，而不是加载完成后，利用js再去编译模板得到html</p> <h3 id="添加index-html"><a href="#添加index-html" aria-hidden="true" class="header-anchor">#</a> 添加index.html</h3> <p>正如我们平时开发SPA一样，需要一个叫做index.html来承载我们的应用，我们在这里也会添加一些重要信息，在上个例子，我们仅仅是利用模板字符串，拼接了html结构，但是这样维护性和可读性很低，我们需要一个SPA一样的index.html,看下面的配置</p> <p><strong>首先添加一个 index.template.html文件</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以看到<strong>文件中有一个特殊的片段 &lt;!--vue-ssr-outlet--&gt;,这是用标志我们的SSR输出片段占用的位置</strong>，简单来说，就是一个占位符，在客户端时，我们会根据el来挂载APP到指定位置，而在服务端，没有DOM，就需要一个这样的标志</p> <p><strong>然后修改一下render</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 设置前代码</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 设置后代码</span>
<span class="token keyword">const</span> templatePath <span class="token operator">=</span> <span class="token string">&quot;./index.template.html&quot;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在这里，我们需要利用fs读取index.html的内容，然后后面就没什么区别了，只是将渲染片段注入的位置交给了程序进行控制</p> <p><strong>对html进行插值</strong></p> <p>在Vue使用的模板中，我们可以随意使用数据驱动视图，为了方便用户，官方支持render使用context为模板注入数据，下面是一个例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 使用双花括号(double-mustache)进行 HTML 转义插值(HTML-escaped interpolation) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 使用三花括号(triple-mustache)进行 HTML 不转义插值(non-HTML-escaped interpolation) --&gt;</span>
    {{{ meta }}}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
  title<span class="token punctuation">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
  meta<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;meta ...&gt;
    &lt;meta ...&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 页面 title 将会是 &quot;Hello&quot;</span>
  <span class="token comment">// meta 标签也会注入</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在这里，我们只需要在模板中使用语法，然后通过renderToString来注入它专属的数据即可</p> <h3 id="客户端激活"><a href="#客户端激活" aria-hidden="true" class="header-anchor">#</a> 客户端激活</h3> <p>为什么会有这个流程呢，一个<strong>组件首先被渲染成了HTML字符串，这里服务器只是单纯输出了我们的HTML，什么交互逻辑都没有</strong>，正如传统的jsp等HTML直出方案，<strong>我们需要类似在生成的页面加入客户端的脚本</strong>，比起JQuery那种直接操作DOM，Vue有点不一样，看下面的例子</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;input type=&quot;text&quot; v-model=&quot;count&quot;&gt;
      &lt;button @click=&quot;plus&quot;&gt;+&lt;/button&gt;
    &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们在app实例上增加了一个小小的交互，<strong>点击按钮就可以将input的数据加一，然而无论我们怎么点击，数据都没有变化，出什么问题了?</strong></p> <p>还记得我们写的SPA么，是这样的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;input type=&quot;text&quot; v-model=&quot;count&quot;&gt;
    &lt;button @click=&quot;plus&quot;&gt;+&lt;/button&gt;
  &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>在<strong>以前我们都设置el属性或者利用$mount来挂载应用</strong>，当然，单纯的字符串HTML，怎么可能能够交互呢，这里我们需要激活，这个步骤很简单，<strong>只需要将相同的代码在客户端运行一遍</strong>，正如下面这样</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用于生产HTML的Vue实例</span>
<span class="token keyword">var</span> app 

<span class="token comment">// 挂载实例</span>

app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>看看效果</p> <p><img src="https://s2.ax1x.com/2019/10/06/uc5q8x.png" alt="uc5q8x.png"></p> <p>已经拥有了我们想要的交互逻辑，到这里，我们的SSR核心流程基本结束，下面附上全部代码</p> <details><summary>index.js</summary> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>

<span class="token comment">// 设置包裹HTML结构</span>
<span class="token keyword">const</span> templatePath <span class="token operator">=</span> <span class="token string">'./index.template.html'</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 配置静态资源</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/client.js'</span><span class="token punctuation">,</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token string">'./client.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Vue</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;input type=&quot;text&quot; v-model=&quot;count&quot;&gt;
      &lt;button @click=&quot;plus&quot;&gt;+&lt;/button&gt;
    &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// HTML包裹数据</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;meta ...&gt;
      &lt;meta ...&gt;
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error'</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不加这行会乱码</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'text/html; charset=utf-8'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>

</code></pre></div></details> <details><summary>index.template.html</summary> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 这里由于需要客户端激活，引入Vue --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.jsdelivr.net/npm/vue/dist/vue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 引入客户端激活脚本 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./client.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div></details> <details><summary>index.template.html</summary> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 简单复制一份Vue</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;input type=&quot;text&quot; v-model=&quot;count&quot;&gt;
    &lt;button @click=&quot;plus&quot;&gt;+&lt;/button&gt;
  &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
</code></pre></div></details> <h2 id="ssr注意点"><a href="#ssr注意点" aria-hidden="true" class="header-anchor">#</a> SSR注意点</h2> <h3 id="生命周期"><a href="#生命周期" aria-hidden="true" class="header-anchor">#</a> 生命周期</h3> <p><strong>beforeCreate created</strong>  只会在服务端渲染时调用，这就意味着在这两个声明周期中，不能使用DOM或者BOM，当然在data函数初始化，也要注意不能出现DOM和BOM</p> <h3 id="服务端数据和客户端数据不一致"><a href="#服务端数据和客户端数据不一致" aria-hidden="true" class="header-anchor">#</a> 服务端数据和客户端数据不一致</h3> <p>由于我们的数据很多时候都是从数据库动态获取的，很可能出现我们<strong>服务端渲染完毕，然后到客户端的时候，数据库的数据已经改变了</strong>，如果我们此时重新获取数据，<strong>在开发环境会重新渲染整个标记的DOM，在生产环境会被跳过</strong></p> <p>这里我尝试了一个例子，将上面的客户端激活代码改为</p> <p><strong>服务端渲染实例</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;ul&gt;
      &lt;li v-for=&quot;item in list&quot;&gt;{{item.name}}&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;cl&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      list
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>客户端激活实例</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;ul&gt;
      &lt;li v-for=&quot;item in list&quot;&gt;{{item.name}}&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;cl&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      list
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>在浏览器我们将网速限制到slow 3G,可以<strong>看到会有一个有列表到列表消失的过程</strong>，当然，这只是正在开发环境的情况，生成环境不会整个替换，官方是说避免性能损耗</p> <p><strong>不进行diff然后重新渲染固然好，这样可以避免闪烁</strong>，但是后期请求数据时，<strong>新的数据和目前SSR生成的HTML数据不一致，会导致视图和数据不同步</strong>，这是个不好的情况，目前官方提供了一个方案</p> <p><strong>数据预取</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>__INITIAL_STATE__ <span class="token operator">=</span> data
</code></pre></div><p>首先<strong>对数据进行ajax预取到vuex，完成后vue-server-renderer会将Vuex中的数据内联到HTML中去</strong>，正如上面代码所示</p> <p><strong>客户端取值</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>按照上述思路，即可保证服务端和客户端使用的数据是一致的，这时候客户端就可以自由操作自己的数据了</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>SSR核心流程是将组件输出为字符串，然后在浏览器端重新运行一遍组件的逻辑，让Vue接管节点，可以解决SEO和首屏渲染等痛点，但是成本高昂，需要权衡，除此之外，也带来一些开发上的问题，格外需要注意。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.df63471f.js" defer></script><script src="/blog/assets/js/2.eb95d593.js" defer></script><script src="/blog/assets/js/96.33b1eaf3.js" defer></script>
  </body>
</html>
